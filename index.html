<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="GAA Tracker">
    <meta name="format-detection" content="telephone=no">
    <title>GAA Possession Tracker</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            background: #f7f7f7;
            overflow-x: hidden; /* Prevent horizontal scrolling */
        }
        /* h1 removed */
        #main-content {
            padding: 30px;
            transition: margin-right 0.3s ease;
        }
        #main-content.panel-open {
            margin-right: 350px; /* Make space for panel */
        }
        .timer-section { display: flex; align-items: center; justify-content: center; gap: 15px; margin: 40px 0 20px; }
        .timer { font-size: 2em; }
        .timer-controls button { padding: 8px 15px; font-size: 0.9em; border-radius: 6px; border: none; background: #ff9800; color: #fff; cursor: pointer; transition: background 0.2s; margin: 0 5px; }
        .timer-controls button:hover { background: #f57c00; }
        .halves { text-align: center; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .players { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; max-width: 900px; margin-left: auto; margin-right: auto; }
        .column-1 { grid-column: 1; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .column-2 { grid-column: 2; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .column-3 { grid-column: 3; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .column-4 { grid-column: 4; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .column-5 { grid-column: 5; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .column-6 { grid-column: 6; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .substitutes { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; max-width: 1050px; margin-left: auto; margin-right: auto; }
        /* Team color variables */
        :root {
            /* Home team colors (red & black) */
            --home-primary: #d32f2f;
            --home-primary-hover: #b71c1c;
            --home-clicked: #000000;
            --home-clicked-hover: #212121;
            --home-sub: #ff5252;
            --home-sub-hover: #ff1744;
            --home-sub-clicked: #9e9e9e;
            --home-sub-clicked-hover: #757575;
            
            /* Opposition team colors (blue & yellow) */
            --opposition-primary: #1976d2;
            --opposition-primary-hover: #1565c0;
            --opposition-clicked: #ffc107;
            --opposition-clicked-hover: #ffb300;
            --opposition-sub: #42a5f5;
            --opposition-sub-hover: #2196f3;
            --opposition-sub-clicked: #ffca28;
            --opposition-sub-clicked-hover: #ffb300;
        }
        
        /* Base player button styles */
        .player-btn { 
            padding: 8px 10px; 
            font-size: 1em; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            width: 135px; 
            height: 80px; 
            position: relative; 
            box-sizing: border-box;
        }
        
        /* Home team colors */
        body.home-team .player-btn { background: var(--home-primary); color: #fff; }
        body.home-team .player-btn:hover { background: var(--home-primary-hover); transform: scale(1.02); }
        body.home-team .player-btn.clicked { background: var(--home-clicked); border: 2px solid #000000; box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); }
        body.home-team .player-btn.clicked:hover { background: var(--home-clicked-hover); }
        body.home-team .player-btn.substitute { background: var(--home-sub); color: #fff; }
        body.home-team .player-btn.substitute:hover { background: var(--home-sub-hover); }
        body.home-team .player-btn.substitute.clicked { background: var(--home-sub-clicked); color: #fff; border: 2px solid #424242; box-shadow: 0 0 10px rgba(158, 158, 158, 0.5); }
        body.home-team .player-btn.substitute.clicked:hover { background: var(--home-sub-clicked-hover); }
        
        /* Opposition team colors */
        body.opposition-team .player-btn { background: var(--opposition-primary); color: #fff; }
        body.opposition-team .player-btn:hover { background: var(--opposition-primary-hover); transform: scale(1.02); }
        body.opposition-team .player-btn.clicked { background: var(--opposition-clicked); color: #000; border: 2px solid #ffa000; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }
        body.opposition-team .player-btn.clicked:hover { background: var(--opposition-clicked-hover); }
        body.opposition-team .player-btn.substitute { background: var(--opposition-sub); color: #fff; }
        body.opposition-team .player-btn.substitute:hover { background: var(--opposition-sub-hover); }
        body.opposition-team .player-btn.substitute.clicked { background: var(--opposition-sub-clicked); color: #000; border: 2px solid #ffa000; box-shadow: 0 0 10px rgba(255, 193, 7, 0.5); }
        body.opposition-team .player-btn.substitute.clicked:hover { background: var(--opposition-sub-clicked-hover); }
        .player-btn.dragging { opacity: 0.5; transform: rotate(5deg); }
        .player-btn.drag-over { border: 3px dashed #333; }
        .player-number { font-size: 1.3em; font-weight: bold; margin-bottom: 2px; line-height: 1.1; }
        .player-name { font-size: 0.85em; text-align: center; line-height: 1.2; word-wrap: break-word; overflow: hidden; max-height: 2.4em; }
        .controls { text-align: center; margin-bottom: 20px; }
        .controls button { margin: 0 10px; padding: 10px 18px; font-size: 1em; border-radius: 8px; border: none; background: #388e3c; color: #fff; cursor: pointer; transition: background 0.2s; }
        .controls button:hover { background: #2e7031; }
        /* Side panel styles */
        .side-panel {
            position: fixed;
            top: 0;
            right: -350px; /* Start off-screen - reduced from 400px */
            width: 350px; /* Reduced from 400px */
            height: 100vh;
            background: #fff;
            box-shadow: -5px 0 15px rgba(0,0,0,0.2);
            transition: right 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
            font-size: 0.92em; /* Slightly smaller font */
        }
        
        .side-panel.active {
            right: 0;
        }
        
        .summary-panel {
            display: block;
        }
        
        .manage-players-panel {
            display: block;
        }
        
        .panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.1); /* Reduced opacity */
            z-index: 999;
            display: none;
            pointer-events: none; /* Let clicks pass through */
        }
        
        .panel-overlay.active {
            display: block;
        }
        
        /* Team toggle styling */
        .team-toggle-container {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            margin-right: 15px;
            vertical-align: middle;
            min-width: 110px; /* Match the minimum width of the button */
        }
        
        .team-toggle-btn {
            padding: 8px 15px;
            font-size: 1em;
            font-weight: bold;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            vertical-align: middle;
            width: calc(100% - 20px); /* Double the length by using percentage width */
            min-width: 110px; /* Ensure minimum width */
        }
        
        .team-toggle-btn.home-active {
            background: linear-gradient(to right, var(--home-primary), var(--home-primary-hover));
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .team-toggle-btn.opposition-active {
            background: linear-gradient(to right, var(--opposition-primary), var(--opposition-primary-hover));
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .team-toggle-btn:after {
            content: '⟲ Switch to Opposition Team';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: inherit;
            display: flex;
            align-items: center;
            justify-content: center;
            transform: translateY(100%);
            transition: transform 0.2s ease;
            font-size: 0.9em;
        }
        
        .team-toggle-btn.opposition-active:after {
            content: '⟲ Switch to Home Team';
        }
        
        .team-toggle-btn:hover:after {
            transform: translateY(0);
        }
        
        .active-team {
            font-size: 0.7em;
            margin-top: 3px;
            color: #555;
            font-style: italic;
            text-align: center;
        }
        
        .summary-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; font-size: 0.9em; }
        .summary-table th, .summary-table td { padding: 8px; text-align: left; border-bottom: 1px solid #ddd; }
        .summary-table th { background: #f5f5f5; cursor: pointer; user-select: none; }
        .summary-table th:hover { background: #e0e0e0; }
        .summary-table th.sorted-asc::after { content: ' ↑'; }
        .summary-table th.sorted-desc::after { content: ' ↓'; }
        .close-panel { float: right; cursor: pointer; font-size: 1.2em; color: #888; margin-bottom: 15px; }
        .close-panel:hover { color: #000; }
        .players-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        .players-table th, .players-table td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .players-table th { background: #f5f5f5; }
        .players-table input { width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .players-table tr { 
            cursor: move; 
            transition: background-color 0.2s; 
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
            position: relative;
        }
        .players-table tr::before {
            content: "≡";
            position: absolute;
            left: -15px;
            font-size: 18px;
            color: #aaa;
            opacity: 0.8;
        }
        .players-table tr:hover { background-color: #f9f9f9; }
        .players-table tr.dragging { 
            opacity: 0.5; 
            background-color: #e3f2fd; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border: 2px dashed #1976d2;
        }
        .players-table tr.drag-over { 
            border-top: 3px solid #1976d2; 
            background-color: rgba(25, 118, 210, 0.1);
        }
        .players-table tr.substitute-separator { border-top: 4px solid #ff6b35; }
        .players-table tr.substitute-separator td { border-bottom: none; padding: 5px 10px; }
        .players-table tr.substitute-separator td:first-child { position: relative; }
        .players-table tr.substitute-separator td:first-child::before { content: "SUBSTITUTES"; position: absolute; top: -18px; left: 0; background: #ff6b35; color: white; padding: 2px 8px; font-size: 0.8em; font-weight: bold; border-radius: 3px; }
        .delete-btn { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .delete-btn:hover { background: #c62828; }
        .add-player-btn { background: #1976d2; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }
        .add-player-btn:hover { background: #1565c0; }
        .save-players-btn { background: #388e3c; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-bottom: 15px; }
        .save-players-btn:hover { background: #2e7031; }
        .clear-btn { background: #d32f2f; }
        .clear-btn:hover { background: #c62828; }
        .time-input { padding: 8px; font-size: 0.9em; border: 1px solid #ddd; border-radius: 4px; width: 80px; text-align: center; }
        .set-time-modal { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
        .set-time-content { background: #fff; padding: 30px; border-radius: 10px; min-width: 300px; text-align: center; }
        .set-time-content h3 { margin-top: 0; }
        .set-time-input { padding: 10px; font-size: 1.2em; border: 1px solid #ddd; border-radius: 4px; width: 120px; text-align: center; margin: 15px 0; }
        .set-time-buttons { margin-top: 20px; }
        .set-time-buttons button { margin: 0 10px; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        .confirm-time-btn { background: #388e3c; color: white; }
        .confirm-time-btn:hover { background: #2e7031; }
        .cancel-time-btn { background: #d32f2f; color: white; }
        .cancel-time-btn:hover { background: #c62828; }
        @media (max-width: 600px) {
            .players { grid-template-columns: repeat(3, 1fr); max-width: 100%; }
            .column-1, .column-2, .column-3, .column-4, .column-5, .column-6 { grid-column: auto; }
            .substitutes { flex-direction: row; justify-content: center; max-width: 100%; }
            .timer-section { flex-direction: column; gap: 10px; }
            
            /* Side panel adjustments for mobile */
            .side-panel {
                width: 85%;
                right: -85%;
            }
            #main-content.panel-open {
                margin-right: 0;
                transform: translateX(-85%);
            }
        }
        @media (max-width: 1024px) and (min-width: 601px) {
            /* iPad-specific styles */
            .players { max-width: 95%; }
            .substitutes { max-width: 98%; }
            .player-btn { width: 115px; height: 70px; font-size: 0.9em; }
            .player-number { font-size: 1.2em; }
            .player-name { font-size: 0.8em; }
            
            /* Side panel adjustments for tablet */
            .side-panel {
                width: 350px;
                right: -350px;
            }
        }
        @media (max-width: 1366px) and (orientation: landscape) {
            /* iPad landscape optimization */
            .players { max-width: 100%; }
            .substitutes { max-width: 100%; }
        }
        
        /* iOS Safari specific styles */
        @supports (-webkit-touch-callout: none) {
            .player-btn {
                position: relative;
            }
            
            /* Add visual cue about dragging ability */
            .player-btn::after {
                content: "Hold to move";
                position: absolute;
                bottom: -18px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0,0,0,0.6);
                color: white;
                padding: 2px 6px;
                border-radius: 10px;
                font-size: 9px;
                opacity: 0;
                transition: opacity 0.3s;
                pointer-events: none;
                white-space: nowrap;
                z-index: 10;
            }
            
            /* Show tip on first page load */
            body:not(.tips-shown) .player-btn:nth-child(1)::after {
                opacity: 0.9;
                animation: fadeInOut 3s forwards;
            }
            
            @keyframes fadeInOut {
                0% { opacity: 0; }
                20% { opacity: 0.9; }
                80% { opacity: 0.9; }
                100% { opacity: 0; }
            }
            
            /* Custom scrolling behavior for iOS */
            .summary-content, .manage-players-content {
                -webkit-overflow-scrolling: touch;
            }
        }
        /* Touch-friendly improvements */
        @media (pointer: coarse) {
            .player-btn { 
                min-height: 60px; /* Increased from Apple's minimum touch target */
                min-width: 100px;
                transition: all 0.2s ease;
                -webkit-user-select: none; /* Safari */
                user-select: none;
                -webkit-touch-callout: none; /* Disable iOS callout on long-press */
            }
            .player-btn:active {
                transform: scale(0.95);
                background: #1565c0;
            }
            .player-btn.substitute:active {
                background: #ffb300;
            }
            .timer-controls button, .controls button {
                min-height: 44px;
                padding: 12px 20px;
            }
            .summary-table th, .summary-table td {
                padding: 12px;
            }
            .players-table th, .players-table td {
                padding: 12px;
            }
            /* Improve drag handles visibility on touch devices */
            .player-btn.is-dragging {
                opacity: 0.8;
                box-shadow: 0 5px 15px rgba(0,0,0,0.3);
                border: 2px dashed #1976d2;
            }
            .player-btn.drag-over {
                border: 3px dashed #ff9800;
                background-color: rgba(255, 152, 0, 0.2);
            }
            /* Improved touch feedback */
            .player-btn::before {
                content: '⬍';
                position: absolute;
                top: 2px;
                right: 2px;
                font-size: 14px;
                opacity: 0.7;
                color: inherit;
            }
        }
    </style>
</head>
<body>
    <div id="main-content">
    
    <div class="timer-section">
        <div class="timer-controls">
            <button id="startBtn">Start</button>
            <button id="stopBtn">Stop</button>
        </div>
        <div class="timer" id="timer">00:00</div>
        <div class="timer-controls">
            <button id="resetClockBtn">Reset Clock</button>
            <button id="setTimeBtn">Set Time</button>
        </div>
    </div>
    <div class="halves">
        <!-- Team Toggle Button -->
        <div class="team-toggle-container">
            <button id="teamToggleBtn" class="team-toggle-btn home-active">Home Team</button>
            <div id="activeTeamIndicator" class="active-team">Home Team Active</div>
        </div>
        <button id="firstHalfBtn">First Half</button>
        <button id="secondHalfBtn">Second Half</button>
        <span id="currentHalf">Current Half: 1</span>
    </div>
    <div class="players" id="players">
        <div class="column-1" id="column-1"></div>
        <div class="column-2" id="column-2"></div>
        <div class="column-3" id="column-3"></div>
        <div class="column-4" id="column-4"></div>
        <div class="column-5" id="column-5"></div>
        <div class="column-6" id="column-6"></div>
    </div>
    <div class="substitutes" id="substitutes"></div>
    <div class="controls">
        <button id="downloadBtn">Download Data</button>
        <button id="summaryBtn">Summary</button>
        <button id="managePlayersBtn">Manage Players</button>
        <button id="clearPossessionsBtn" class="clear-btn">Clear Possessions</button>
    </div>
    </div> <!-- End of main-content -->
    <!-- Panel overlay background -->
    <div class="panel-overlay" id="panelOverlay"></div>
    
    <!-- Summary side panel -->
    <div class="side-panel summary-panel" id="summaryPanel">
        <span class="close-panel" id="closeSummary">&times;</span>
        <h2 id="summaryTitle">Home Team Summary</h2>
        <div style="margin-bottom: 15px;">
            <label for="halfFilter" style="margin-right: 10px; font-weight: bold;">Filter by Half:</label>
            <select id="halfFilter" onchange="renderSummaryTable()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px; margin-right: 20px;">
                <option value="both">Both Halves</option>
                <option value="1">First Half</option>
                <option value="2">Second Half</option>
            </select>
            <label for="timeFilter" style="margin-right: 10px; font-weight: bold;">Last X Minutes:</label>
            <select id="timeFilter" onchange="renderSummaryTable()" style="padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="all">All</option>
                <option value="30">30 minutes</option>
                <option value="25">25 minutes</option>
                <option value="20">20 minutes</option>
                <option value="15">15 minutes</option>
                <option value="10">10 minutes</option>
                <option value="5">5 minutes</option>
            </select>
        </div>
        <table class="summary-table" id="summaryTable">
            <thead>
                <tr>
                    <th onclick="sortSummary('number')">Number</th>
                    <th onclick="sortSummary('name')">Name</th>
                    <th onclick="sortSummary('possessions')">Possessions</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody">
            </tbody>
        </table>
    </div>
    
    <!-- Manage Players side panel -->
    <div class="side-panel manage-players-panel" id="managePlayersPanel">
        <span class="close-panel" id="closeManagePlayers">&times;</span>
        <h2>Manage Players</h2>
        <table class="players-table" id="playersTable">
            <thead>
                <tr>
                    <th>Number</th>
                    <th>Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="playersTableBody">
            </tbody>
        </table>
        <div style="margin-top: 20px; text-align: center;">
            <button class="add-player-btn" onclick="addPlayer()">Add New Player</button>
            <button class="save-players-btn" id="savePlayersBtn">Save Changes</button>
        </div>
    </div>
    <div class="set-time-modal" id="setTimeModal">
        <div class="set-time-content">
            <h3>Set Game Time</h3>
            <input type="text" class="set-time-input" id="setTimeInput" placeholder="mm:ss" maxlength="5">
            <div class="set-time-buttons">
                <button class="confirm-time-btn" id="confirmTimeBtn">Set Time</button>
                <button class="cancel-time-btn" id="cancelTimeBtn">Cancel</button>
            </div>
        </div>
    </div>
    <script>
        // --- CONFIG ---
        // Define default player lists for home and opposition teams
        const defaultHomePlayers = [
            { number: 1, name: "Player 1" },
            { number: 2, name: "Player 2" },
            { number: 3, name: "Player 3" },
            { number: 4, name: "Player 4" },
            { number: 5, name: "Player 5" },
            { number: 6, name: "Player 6" },
            { number: 7, name: "Player 7" },
            { number: 8, name: "Player 8" },
            { number: 9, name: "Player 9" },
            { number: 10, name: "Player 10" },
            { number: 11, name: "Player 11" },
            { number: 12, name: "Player 12" },
            { number: 13, name: "Player 13" },
            { number: 14, name: "Player 14" },
            { number: 15, name: "Player 15" }
        ];
        
        const defaultOppositionPlayers = [
            { number: 1, name: "Opp 1" },
            { number: 2, name: "Opp 2" },
            { number: 3, name: "Opp 3" },
            { number: 4, name: "Opp 4" },
            { number: 5, name: "Opp 5" },
            { number: 6, name: "Opp 6" },
            { number: 7, name: "Opp 7" },
            { number: 8, name: "Opp 8" },
            { number: 9, name: "Opp 9" },
            { number: 10, name: "Opp 10" },
            { number: 11, name: "Opp 11" },
            { number: 12, name: "Opp 12" },
            { number: 13, name: "Opp 13" },
            { number: 14, name: "Opp 14" },
            { number: 15, name: "Opp 15" }
        ];

        // Team tracking variables
        let isHomeTeam = true; // True for home team, false for opposition team
        let homePlayers = [...defaultHomePlayers];
        let oppositionPlayers = [...defaultOppositionPlayers];
        let players = homePlayers; // Active players list

        // Load players from localStorage if available
        function loadPlayers() {
            const savedHomePlayers = localStorage.getItem('homePlayers');
            if (savedHomePlayers) {
                homePlayers = JSON.parse(savedHomePlayers);
            }
            
            const savedOppositionPlayers = localStorage.getItem('oppositionPlayers');
            if (savedOppositionPlayers) {
                oppositionPlayers = JSON.parse(savedOppositionPlayers);
            }
            
            // Set the active players based on current team
            players = isHomeTeam ? homePlayers : oppositionPlayers;
        }

        // Save players to localStorage
        function savePlayers() {
            // Update the appropriate team's players array
            if (isHomeTeam) {
                homePlayers = [...players];
                localStorage.setItem('homePlayers', JSON.stringify(homePlayers));
            } else {
                oppositionPlayers = [...players];
                localStorage.setItem('oppositionPlayers', JSON.stringify(oppositionPlayers));
            }
        }
        
        // Toggle between home and opposition teams
        function toggleTeam() {
            // Save current team data before switching
            savePlayers();
            
            // Toggle the team flag
            isHomeTeam = !isHomeTeam;
            
            // Update active players list
            players = isHomeTeam ? homePlayers : oppositionPlayers;
            
            // Update UI to reflect the active team
            const body = document.body;
            const toggleBtn = document.getElementById('teamToggleBtn');
            const teamIndicator = document.getElementById('activeTeamIndicator');
            
            if (isHomeTeam) {
                body.classList.add('home-team');
                body.classList.remove('opposition-team');
                toggleBtn.classList.add('home-active');
                toggleBtn.classList.remove('opposition-active');
                toggleBtn.textContent = 'Home Team';
                teamIndicator.textContent = 'Home Team Active';
            } else {
                body.classList.add('opposition-team');
                body.classList.remove('home-team');
                toggleBtn.classList.add('opposition-active');
                toggleBtn.classList.remove('home-active');
                toggleBtn.textContent = 'Opposition Team';
                teamIndicator.textContent = 'Opposition Team Active';
            }
            
            // Re-render the players for the active team
            renderPlayers();
        }
        // --- TIMER ---
        let timer = 0;
        let interval = null;
        let running = false;
        let currentHalf = 1;
        function updateTimerDisplay() {
            const mins = String(Math.floor(timer / 60)).padStart(2, '0');
            const secs = String(timer % 60).padStart(2, '0');
            document.getElementById('timer').textContent = `${mins}:${secs}`;
        }
        function startTimer() {
            if (!running) {
                interval = setInterval(() => {
                    timer++;
                    updateTimerDisplay();
                }, 1000);
                running = true;
            }
        }
        function stopTimer() {
            if (running) {
                clearInterval(interval);
                running = false;
            }
        }
        function setHalf(half) {
            currentHalf = half;
            document.getElementById('currentHalf').textContent = `Current Half: ${half}`;
            // Don't reset timer or stop it when changing halves
        }
        
        function resetClock() {
            timer = 0;
            updateTimerDisplay();
            stopTimer();
        }

        function setTime() {
            document.getElementById('setTimeModal').style.display = 'flex';
            document.getElementById('setTimeInput').focus();
        }

        function confirmSetTime() {
            const timeInput = document.getElementById('setTimeInput');
            const timeValue = timeInput.value.trim();
            
            // Validate format (mm:ss)
            const timeRegex = /^(\d{1,2}):(\d{2})$/;
            const match = timeValue.match(timeRegex);
            
            if (match) {
                const minutes = parseInt(match[1]);
                const seconds = parseInt(match[2]);
                
                if (seconds < 60) {
                    timer = (minutes * 60) + seconds;
                    updateTimerDisplay();
                    hideSetTimeModal();
                } else {
                    alert('Seconds must be less than 60');
                }
            } else {
                alert('Please enter time in mm:ss format (e.g., 15:30)');
            }
        }

        function hideSetTimeModal() {
            document.getElementById('setTimeModal').style.display = 'none';
            document.getElementById('setTimeInput').value = '';
        }
        // --- POSSESSION TRACKING ---
        function savePossession(jersey) {
            const now = new Date();
            const time = now.toISOString();
            // Include team information in the possession data
            const data = { 
                time, 
                jersey, 
                half: currentHalf, 
                timer: timer,
                team: isHomeTeam ? 'home' : 'opposition'
            };
            
            // Get appropriate possession storage based on team
            const storageKey = isHomeTeam ? 'homePossessions' : 'oppositionPossessions';
            let possessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            possessions.push(data);
            localStorage.setItem(storageKey, JSON.stringify(possessions));
            
            // Add visual feedback - find the button and add clicked class
            const allButtons = document.querySelectorAll('.player-btn');
            allButtons.forEach(btn => {
                if (btn.querySelector('.player-number').textContent == jersey) {
                    btn.classList.add('clicked');
                    // Remove the clicked class after 1 second
                    setTimeout(() => {
                        btn.classList.remove('clicked');
                    }, 1000);
                }
            });
        }
        // --- PLAYER BUTTONS ---
        function renderPlayers() {
            // Clear all columns
            for (let i = 1; i <= 6; i++) {
                const column = document.getElementById(`column-${i}`);
                if (column) column.innerHTML = '';
            }
            
            const subsContainer = document.getElementById('substitutes');
            subsContainer.innerHTML = '';
            
            // Define column capacities: [1, 3, 3, 2, 3, 3] = 15 total
            const columnCapacities = [1, 3, 3, 2, 3, 3];
            const columnContainers = [
                document.getElementById('column-1'),
                document.getElementById('column-2'),
                document.getElementById('column-3'),
                document.getElementById('column-4'),
                document.getElementById('column-5'),
                document.getElementById('column-6')
            ];
            
            let playerIndex = 0;
            
            // Fill main players (first 15) into columns top-down
            for (let col = 0; col < columnCapacities.length && playerIndex < Math.min(players.length, 15); col++) {
                const capacity = columnCapacities[col];
                const container = columnContainers[col];
                
                // Special case for column 1: add empty space at top, player in second position
                if (col === 0) {
                    // Add empty spacer div
                    const spacer = document.createElement('div');
                    spacer.style.height = '80px'; // Same height as player button
                    spacer.style.width = '135px'; // Same width as player button
                    container.appendChild(spacer);
                }
                
                for (let pos = 0; pos < capacity && playerIndex < Math.min(players.length, 15); pos++) {
                    const p = players[playerIndex];
                    const btn = createPlayerButton(p, playerIndex);
                    container.appendChild(btn);
                    playerIndex++;
                }
            }
            
            // Handle substitutes (>15) in rows of max 6
            let subsRowContainer = null;
            let subsInCurrentRow = 0;
            const maxSubsPerRow = 7;
            
            for (let i = 15; i < players.length; i++) {
                if (subsInCurrentRow === 0) {
                    // Create new row container
                    subsRowContainer = document.createElement('div');
                    subsRowContainer.style.display = 'flex';
                    subsRowContainer.style.gap = '10px';
                    subsRowContainer.style.justifyContent = 'flex-start';
                    subsRowContainer.style.width = '100%';
                    subsContainer.appendChild(subsRowContainer);
                }
                
                const p = players[i];
                const btn = createPlayerButton(p, i);
                subsRowContainer.appendChild(btn);
                
                subsInCurrentRow++;
                if (subsInCurrentRow >= maxSubsPerRow) {
                    subsInCurrentRow = 0;
                }
            }
        }
        
        function createPlayerButton(player, index) {
            const btn = document.createElement('button');
            btn.className = index < 15 ? 'player-btn' : 'player-btn substitute';
            btn.draggable = true;
            btn.dataset.playerIndex = index;
            btn.dataset.playerNumber = player.number;
            btn.innerHTML = `
                <div class="player-number">${player.number}</div>
                <div class="player-name">${player.name}</div>
            `;
            
            // Add click handler for possession tracking
            btn.onclick = (e) => {
                if (!isDragging && !e.target.closest('.player-btn').classList.contains('dragging')) {
                    savePossession(player.number);
                }
            };
            
            // Add drag event listeners for desktop
            btn.addEventListener('dragstart', handleDragStart);
            btn.addEventListener('dragover', handleDragOver);
            btn.addEventListener('drop', handleDrop);
            btn.addEventListener('dragend', handleDragEnd);
            
            // Add touch event listeners for mobile
            btn.addEventListener('touchstart', handleTouchStart, {passive: false});
            btn.addEventListener('touchmove', handleTouchMove, {passive: false});
            btn.addEventListener('touchend', handleTouchEnd);
            
            return btn;
        }

        // --- DRAG AND DROP FUNCTIONALITY ---
        let draggedElement = null;
        let isDragging = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let longPressTimer = null;
        
        // For tracking touch positions
        let lastTouch = null;

        function handleDragStart(e) {
            isDragging = true;
            draggedElement = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedElement !== this) {
                const draggedIndex = parseInt(draggedElement.dataset.playerIndex);
                const targetIndex = parseInt(this.dataset.playerIndex);
                
                // Swap players in the array
                [players[draggedIndex], players[targetIndex]] = [players[targetIndex], players[draggedIndex]];
                
                // Save the new order
                savePlayers();
                
                // Re-render the players
                renderPlayers();
            }

            this.classList.remove('drag-over');
            isDragging = false;
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            // Clean up any remaining drag-over classes
            document.querySelectorAll('.player-btn').forEach(btn => {
                btn.classList.remove('drag-over');
            });
            isDragging = false;
        }
        
        // Touch event handlers for mobile devices
        function handleTouchStart(e) {
            // Store the initial touch position
            if (e.touches.length === 1) {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                
                // Set up long press detection for drag initiation
                clearTimeout(longPressTimer);
                
                const element = this;
                longPressTimer = setTimeout(() => {
                    // Start drag mode after long press
                    isDragging = true;
                    draggedElement = element;
                    element.classList.add('is-dragging');
                    
                    // Provide visual feedback
                    navigator.vibrate && navigator.vibrate(50); // Vibration feedback if supported
                    
                }, 300); // 300ms for long press
            }
        }
        
        function handleTouchMove(e) {
            if (!isDragging) {
                // If not yet dragging, check if movement is significant enough to cancel long press
                if (e.touches.length === 1) {
                    const touchX = e.touches[0].clientX;
                    const touchY = e.touches[0].clientY;
                    
                    // If moved more than 10px, cancel long press timer (normal scroll)
                    if (Math.abs(touchX - touchStartX) > 10 || Math.abs(touchY - touchStartY) > 10) {
                        clearTimeout(longPressTimer);
                    }
                }
                return;
            }
            
            // Prevent page scrolling while dragging
            e.preventDefault();
            
            if (e.touches.length === 1) {
                lastTouch = e.touches[0];
                
                // Find element under the touch point
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                
                // Remove drag-over class from all elements
                document.querySelectorAll('.player-btn').forEach(btn => {
                    btn.classList.remove('drag-over');
                });
                
                // Find the element under the touch point
                const elemUnderTouch = document.elementFromPoint(touchX, touchY);
                const playerBtnUnderTouch = elemUnderTouch?.closest('.player-btn');
                
                if (playerBtnUnderTouch && playerBtnUnderTouch !== draggedElement) {
                    playerBtnUnderTouch.classList.add('drag-over');
                }
            }
        }
        
        function handleTouchEnd(e) {
            // Clear the long press timer
            clearTimeout(longPressTimer);
            
            // If not in dragging mode, this is a normal tap
            if (!isDragging) {
                return;
            }
            
            // Find the element where the touch ended
            let dropTarget = null;
            
            if (lastTouch) {
                const elemUnderTouch = document.elementFromPoint(lastTouch.clientX, lastTouch.clientY);
                dropTarget = elemUnderTouch?.closest('.player-btn');
            }
            
            // If we found a valid drop target
            if (dropTarget && dropTarget !== draggedElement) {
                const draggedIndex = parseInt(draggedElement.dataset.playerIndex);
                const targetIndex = parseInt(dropTarget.dataset.playerIndex);
                
                // Swap players in the array
                [players[draggedIndex], players[targetIndex]] = [players[targetIndex], players[draggedIndex]];
                
                // Save the new order
                savePlayers();
                
                // Re-render the players
                renderPlayers();
            }
            
            // Clean up
            if (draggedElement) {
                draggedElement.classList.remove('is-dragging');
            }
            
            document.querySelectorAll('.player-btn').forEach(btn => {
                btn.classList.remove('drag-over');
            });
            
            isDragging = false;
            draggedElement = null;
            lastTouch = null;
        }
        // --- DOWNLOAD DATA ---
        function downloadData() {
            // Create dialog with options to download specific team data or both
            const teamType = confirm('Do you want to download data for both teams?\nClick OK for both teams, or Cancel for current team only.');
            
            let possessions = [];
            let filename = '';
            
            if (teamType) {
                // Download both teams' data
                const homePossessions = JSON.parse(localStorage.getItem('homePossessions') || '[]');
                const oppositionPossessions = JSON.parse(localStorage.getItem('oppositionPossessions') || '[]');
                possessions = [...homePossessions, ...oppositionPossessions];
                filename = 'all_possessions.csv';
            } else {
                // Download current team data only
                const storageKey = isHomeTeam ? 'homePossessions' : 'oppositionPossessions';
                const teamName = isHomeTeam ? 'home' : 'opposition';
                possessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
                filename = `${teamName}_possessions.csv`;
            }
            
            // Create CSV with team information
            let csv = 'timestamp,jersey,half,timer,team\n';
            possessions.forEach(d => {
                const team = d.team || (d.team === undefined ? (isHomeTeam ? 'home' : 'opposition') : d.team);
                csv += `${d.time},${d.jersey},${d.half},${d.timer},${team}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        // --- SUMMARY ---
        let summarySort = { column: null, direction: null };

        function showSummary() {
            // Reset sort to default (manage players order) every time summary is opened
            summarySort = { column: null, direction: null };
            // Reset half filter to "both" every time summary is opened
            document.getElementById('halfFilter').value = 'both';
            // Reset time filter to "all" every time summary is opened
            document.getElementById('timeFilter').value = 'all';
            renderSummaryTable();
            
            // Hide manage players panel if open
            document.getElementById('managePlayersPanel').classList.remove('active');
            
            // Show summary panel
            document.getElementById('summaryPanel').classList.add('active');
            document.getElementById('panelOverlay').classList.add('active');
            
            // Shift main content
            document.getElementById('main-content').classList.add('panel-open');
        }

        function renderSummaryTable() {
            // Get team-specific possessions based on active team
            const storageKey = isHomeTeam ? 'homePossessions' : 'oppositionPossessions';
            const possessions = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const halfFilter = document.getElementById('halfFilter').value;
            const timeFilter = document.getElementById('timeFilter').value;
            
            // Update title to show which team data is being displayed
            const summaryTitle = document.getElementById('summaryTitle');
            if (summaryTitle) {
                summaryTitle.textContent = isHomeTeam ? 'Home Team Summary' : 'Opposition Team Summary';
            }
            
            // Filter possessions by selected half
            let filteredPossessions = halfFilter === 'both' 
                ? possessions 
                : possessions.filter(p => p.half && p.half.toString() === halfFilter);
            
            // Filter by time if not "all"
            if (timeFilter !== 'all') {
                const timeFilterMinutes = parseInt(timeFilter);
                const timeFilterSeconds = timeFilterMinutes * 60;
                
                if (halfFilter === 'both') {
                    // For both halves, get max timer value for each half
                    const half1Max = Math.max(0, ...filteredPossessions
                        .filter(p => p.half === 1)
                        .map(p => p.timer || 0));
                    const half2Max = Math.max(0, ...filteredPossessions
                        .filter(p => p.half === 2)
                        .map(p => p.timer || 0));
                    
                    filteredPossessions = filteredPossessions.filter(p => {
                        if (p.half === 1) {
                            return (p.timer || 0) >= (half1Max - timeFilterSeconds);
                        } else if (p.half === 2) {
                            return (p.timer || 0) >= (half2Max - timeFilterSeconds);
                        }
                        return true;
                    });
                } else {
                    // For single half, get max timer value and filter
                    const maxTimer = Math.max(0, ...filteredPossessions.map(p => p.timer || 0));
                    filteredPossessions = filteredPossessions.filter(p => 
                        (p.timer || 0) >= (maxTimer - timeFilterSeconds)
                    );
                }
            }
            
            const counts = {};
            players.forEach(p => counts[p.number] = 0);
            filteredPossessions.forEach(d => {
                if (counts[d.jersey] !== undefined) counts[d.jersey]++;
            });

            // Create array with possession data maintaining the order from manage players screen
            const summaryData = players.map((player, index) => ({
                number: player.number,
                name: player.name,
                possessions: counts[player.number] || 0,
                originalOrder: index
            }));

            // Sort based on current sort settings, but default to manage players order
            if (summarySort.column && summarySort.column !== 'order') {
                summaryData.sort((a, b) => {
                    let aVal = a[summarySort.column];
                    let bVal = b[summarySort.column];
                    
                    if (summarySort.column === 'number' || summarySort.column === 'possessions') {
                        aVal = Number(aVal);
                        bVal = Number(bVal);
                    }
                    
                    if (summarySort.direction === 'asc') {
                        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                    } else {
                        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                    }
                });
            } else {
                // Default to manage players order (no sorting applied)
                summaryData.sort((a, b) => a.originalOrder - b.originalOrder);
            }

            const tbody = document.getElementById('summaryTableBody');
            tbody.innerHTML = '';
            
            summaryData.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.number}</td>
                    <td>${player.name}</td>
                    <td>${player.possessions}</td>
                `;
                tbody.appendChild(row);
            });

            // Update sort indicators
            document.querySelectorAll('.summary-table th').forEach(th => {
                th.className = '';
            });
            const sortedHeader = document.querySelector(`[onclick="sortSummary('${summarySort.column}')"]`);
            if (sortedHeader) {
                sortedHeader.className = `sorted-${summarySort.direction}`;
            }
        }

        function sortSummary(column) {
            if (summarySort.column === column) {
                summarySort.direction = summarySort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                summarySort.column = column;
                summarySort.direction = column === 'possessions' ? 'desc' : 'asc'; // Default possessions to descending
            }
            renderSummaryTable();
        }

        function hideSummary() {
            document.getElementById('summaryPanel').classList.remove('active');
            document.getElementById('panelOverlay').classList.remove('active');
            
            // Reset main content position
            document.getElementById('main-content').classList.remove('panel-open');
        }

        // --- PLAYER MANAGEMENT ---
        function showManagePlayers() {
            renderPlayerManagement();
            
            // Hide summary panel if open
            document.getElementById('summaryPanel').classList.remove('active');
            
            // Show manage players panel
            document.getElementById('managePlayersPanel').classList.add('active');
            document.getElementById('panelOverlay').classList.add('active');
            
            // Shift main content
            document.getElementById('main-content').classList.add('panel-open');
        }

        function hideManagePlayers() {
            document.getElementById('managePlayersPanel').classList.remove('active');
            document.getElementById('panelOverlay').classList.remove('active');
            
            // Reset main content position
            document.getElementById('main-content').classList.remove('panel-open');
        }

        function renderPlayerManagement() {
            const tbody = document.getElementById('playersTableBody');
            
            tbody.innerHTML = '';
            
            players.forEach((player, index) => {
                const row = document.createElement('tr');
                row.draggable = true;
                row.dataset.playerIndex = index;
                
                // Add separator class for the 16th player (index 15) to show substitutes start
                if (index === 15 && players.length > 15) {
                    row.classList.add('substitute-separator');
                }
                
                row.innerHTML = `
                    <td><input type="number" value="${player.number}" data-index="${index}" data-field="number"></td>
                    <td><input type="text" value="${player.name}" data-index="${index}" data-field="name"></td>
                    <td><button class="delete-btn" onclick="removePlayer(${index})">Delete</button></td>
                `;
                
                // Add drag event listeners to the row
                row.addEventListener('dragstart', handleTableDragStart);
                row.addEventListener('dragover', handleTableDragOver);
                row.addEventListener('drop', handleTableDrop);
                row.addEventListener('dragend', handleTableDragEnd);
                
                tbody.appendChild(row);
            });
            
            // Add touch support for mobile devices
            setTimeout(enhanceTableRowsWithTouchEvents, 0); // Use setTimeout to ensure DOM is ready
        }
        
        // --- TABLE DRAG AND DROP FUNCTIONALITY ---
        let draggedTableRow = null;
        let tableTouchStartY = 0;
        let tableLongPressTimer = null;
        let isTableDragging = false;
        let lastTableTouch = null;

        function handleTableDragStart(e) {
            isTableDragging = true;
            draggedTableRow = this;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.outerHTML);
        }

        function handleTableDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            this.classList.add('drag-over');
            return false;
        }

        function handleTableDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }

            if (draggedTableRow !== this) {
                const draggedIndex = parseInt(draggedTableRow.dataset.playerIndex);
                const targetIndex = parseInt(this.dataset.playerIndex);
                
                // Move player to new position
                const movedPlayer = players.splice(draggedIndex, 1)[0];
                players.splice(targetIndex, 0, movedPlayer);
                
                // Re-render the table with new order
                renderPlayerManagement();
            }

            this.classList.remove('drag-over');
            isTableDragging = false;
            return false;
        }

        function handleTableDragEnd(e) {
            this.classList.remove('dragging');
            // Clean up any remaining drag-over classes
            document.querySelectorAll('.players-table tr').forEach(row => {
                row.classList.remove('drag-over');
            });
            isTableDragging = false;
        }
        
        // Add touch support for table rows in player management
        function enhanceTableRowsWithTouchEvents() {
            document.querySelectorAll('.players-table tbody tr').forEach(row => {
                row.addEventListener('touchstart', handleTableTouchStart, {passive: false});
                row.addEventListener('touchmove', handleTableTouchMove, {passive: false});
                row.addEventListener('touchend', handleTableTouchEnd);
            });
        }
        
        function handleTableTouchStart(e) {
            // Only proceed if touching the row itself, not an input field
            if (e.target.tagName.toLowerCase() === 'input') {
                return;
            }
            
            // Store start position
            if (e.touches.length === 1) {
                tableTouchStartY = e.touches[0].clientY;
                
                // Set up long press detection
                clearTimeout(tableLongPressTimer);
                
                const row = this;
                tableLongPressTimer = setTimeout(() => {
                    // Start drag mode after long press
                    isTableDragging = true;
                    draggedTableRow = row;
                    row.classList.add('dragging');
                    
                    // Provide haptic feedback if available
                    navigator.vibrate && navigator.vibrate(50);
                    
                }, 300); // 300ms for long press
            }
        }
        
        function handleTableTouchMove(e) {
            if (!isTableDragging) {
                // If not dragging, check if movement is significant to cancel long press
                if (e.touches.length === 1) {
                    const touchY = e.touches[0].clientY;
                    
                    // If moved more than 10px vertically, cancel long press (normal scroll)
                    if (Math.abs(touchY - tableTouchStartY) > 10) {
                        clearTimeout(tableLongPressTimer);
                    }
                }
                return;
            }
            
            // Prevent scrolling while dragging
            e.preventDefault();
            
            if (e.touches.length === 1) {
                lastTableTouch = e.touches[0];
                
                // Find element under touch point
                const touchY = e.touches[0].clientY;
                
                // Remove drag-over class from all rows
                document.querySelectorAll('.players-table tr').forEach(row => {
                    row.classList.remove('drag-over');
                });
                
                // Find the row under the touch point
                const elemUnderTouch = document.elementFromPoint(e.touches[0].clientX, touchY);
                const rowUnderTouch = elemUnderTouch?.closest('tr');
                
                if (rowUnderTouch && rowUnderTouch !== draggedTableRow) {
                    rowUnderTouch.classList.add('drag-over');
                }
            }
        }
        
        function handleTableTouchEnd(e) {
            // Clear the long press timer
            clearTimeout(tableLongPressTimer);
            
            // If not in dragging mode, this is a normal tap
            if (!isTableDragging) {
                return;
            }
            
            // Find the row where touch ended
            let dropTarget = null;
            
            if (lastTableTouch) {
                const elemUnderTouch = document.elementFromPoint(lastTableTouch.clientX, lastTableTouch.clientY);
                dropTarget = elemUnderTouch?.closest('tr');
            }
            
            // If we found a valid drop target
            if (dropTarget && dropTarget !== draggedTableRow && dropTarget.dataset.playerIndex !== undefined) {
                const draggedIndex = parseInt(draggedTableRow.dataset.playerIndex);
                const targetIndex = parseInt(dropTarget.dataset.playerIndex);
                
                // Move player to new position
                const movedPlayer = players.splice(draggedIndex, 1)[0];
                players.splice(targetIndex, 0, movedPlayer);
                
                // Re-render with new order
                renderPlayerManagement();
                // Re-add touch events after re-rendering
                enhanceTableRowsWithTouchEvents();
            }
            
            // Clean up
            if (draggedTableRow) {
                draggedTableRow.classList.remove('dragging');
            }
            
            document.querySelectorAll('.players-table tr').forEach(row => {
                row.classList.remove('drag-over');
            });
            
            isTableDragging = false;
            draggedTableRow = null;
            lastTableTouch = null;
        }

        function addPlayer() {
            // Find the next available number
            const existingNumbers = players.map(p => p.number);
            let nextNumber = 1;
            while (existingNumbers.includes(nextNumber)) {
                nextNumber++;
            }
            
            // Add new player
            players.push({
                number: nextNumber,
                name: `Player ${nextNumber}`
            });
            
            renderPlayerManagement();
        }

        function removePlayer(index) {
            if (players.length <= 1) {
                alert('You must have at least one player.');
                return;
            }
            
            if (confirm(`Are you sure you want to remove ${players[index].name}?`)) {
                players.splice(index, 1);
                renderPlayerManagement();
            }
        }

        function savePlayerChanges() {
            const inputs = document.querySelectorAll('#playersTableBody input');
            inputs.forEach(input => {
                const index = parseInt(input.dataset.index);
                const field = input.dataset.field;
                if (field === 'number') {
                    players[index].number = parseInt(input.value) || 1;
                } else {
                    players[index].name = input.value || `Player ${players[index].number}`;
                }
            });
            savePlayers();
            renderPlayers();
            hideManagePlayers();
        }

        function getPossessionCounts() {
            const possessions = JSON.parse(localStorage.getItem('possessions') || '[]');
            const counts = {};
            players.forEach(p => counts[p.number] = 0);
            possessions.forEach(d => {
                if (counts[d.jersey] !== undefined) counts[d.jersey]++;
            });
            return counts;
        }

        // --- CLEAR POSSESSIONS ---
        function clearPossessions() {
            const teamType = isHomeTeam ? 'home' : 'opposition';
            const storageKey = isHomeTeam ? 'homePossessions' : 'oppositionPossessions';
            
            if (confirm(`Are you sure you want to clear all ${teamType} team possession data? This cannot be undone.`)) {
                localStorage.removeItem(storageKey);
                alert(`${teamType.charAt(0).toUpperCase() + teamType.slice(1)} team possession data cleared!`);
            }
        }
        // --- EVENT LISTENERS ---
        document.getElementById('startBtn').onclick = startTimer;
        document.getElementById('stopBtn').onclick = stopTimer;
        document.getElementById('resetClockBtn').onclick = resetClock;
        document.getElementById('setTimeBtn').onclick = setTime;
        document.getElementById('confirmTimeBtn').onclick = confirmSetTime;
        document.getElementById('cancelTimeBtn').onclick = hideSetTimeModal;
        document.getElementById('firstHalfBtn').onclick = () => setHalf(1);
        document.getElementById('secondHalfBtn').onclick = () => setHalf(2);
        document.getElementById('downloadBtn').onclick = downloadData;
        document.getElementById('summaryBtn').onclick = showSummary;
        document.getElementById('managePlayersBtn').onclick = showManagePlayers;
        document.getElementById('clearPossessionsBtn').onclick = clearPossessions;
        document.getElementById('closeSummary').onclick = hideSummary;
        document.getElementById('closeManagePlayers').onclick = hideManagePlayers;
        document.getElementById('savePlayersBtn').onclick = savePlayerChanges;
        document.getElementById('teamToggleBtn').onclick = toggleTeam;
        
        // Allow Enter key to confirm set time
        document.getElementById('setTimeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                confirmSetTime();
            }
        });
        
        // We're not using overlay clicks anymore since we made the overlay pointer-events: none
        // to allow interaction with the main content
        
        window.onclick = function(event) {
            if (event.target === document.getElementById('setTimeModal')) hideSetTimeModal();
        };
        // --- INIT ---
        // Set initial team styling
        document.body.classList.add('home-team');
        
        // Migrate data from old storage format if needed
        (function migrateData() {
            const oldPossessions = localStorage.getItem('possessions');
            if (oldPossessions) {
                // If we have old-format data but no team-specific data yet
                if (!localStorage.getItem('homePossessions')) {
                    // Assume all old possessions belong to home team
                    localStorage.setItem('homePossessions', oldPossessions);
                    console.log('Migrated existing possession data to home team');
                    
                    // Keep old data as backup but rename it
                    localStorage.setItem('possessions_backup', oldPossessions);
                    localStorage.removeItem('possessions');
                }
            }
        })();
        
        // Load players and render the app
        loadPlayers();
        renderPlayers();
        updateTimerDisplay();
        
        // Set a flag to show drag tips only on first page load
        if (!localStorage.getItem('tips-shown')) {
            localStorage.setItem('tips-shown', 'true');
        } else {
            document.body.classList.add('tips-shown');
        }
        
        // Add iOS detection
        if (/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream) {
            document.body.classList.add('ios-device');
        }
    </script>
</body>
</html>
